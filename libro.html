<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Libro ‚Äì Librarium.es</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/estilos.css">
  <meta name="description" content="Ficha completa del libro con valoraci√≥n, resumen y detalles.">
  <style>
    /* Estilos m√≠nimos si falta el CSS */
    body{font-family:system-ui,Segoe UI,Roboto,Arial;line-height:1.5;margin:0;background:#f7f7f7;color:#222}
    .container{max-width:980px;margin:20px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .header, .footer{background:transparent}
    .grid{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap}
    .cover{width:200px;flex:0 0 200px}
    .cover img{width:100%;border-radius:4px;display:block}
    .meta h1{margin:0 0 8px;font-size:1.6rem}
    .meta p{margin:6px 0;color:#555}
    .btn-secondary{display:inline-block;padding:10px 16px;background:#ff9900;color:#111;border-radius:6px;text-decoration:none;font-weight:600}
    .small{font-size:.9rem;color:#666;margin-top:8px}
    .hero .container{padding:40px}
  </style>
</head>

<body>

<header class="header">
  <div class="container header-flex">
    <div class="logo-box">
      <span class="logo-icon">üìö</span>
      <span class="logo-text">Librarium.es</span>
    </div>

    <nav class="menu">
      <a href="index.html">Inicio</a>
      <a href="blog.html">Blog</a>
      <a href="rankings.html">Rankings</a>
      <a href="resenas.html">Rese√±as</a>
      <a href="contacto.html">Contacto</a>
    </nav>
  </div>
</header>

<section class="hero" style="background-image: url('img/hero.png');">
  <div class="container" style="background: rgba(0,0,0,0.55); padding: 50px 30px; border-radius: 12px;">
    <h2 id="tituloHero" style="color: #fff; font-size: 2.2rem;">Cargando...</h2>
  </div>
</section>

<main class="container">

  <section class="section" id="contenidoLibro">
    <p>Cargando datos...</p>
  </section>

</main>

<footer class="footer">
  <div class="container">
    <p>¬© 2025 Librarium.es ‚Äì Todos los derechos reservados</p>
    <div class="footer-links">
      <a href="privacidad.html">Pol√≠tica de privacidad</a>
      <a href="cookies.html">Pol√≠tica de cookies</a>
      <a href="aviso-legal.html">Aviso legal</a>
    </div>
  </div>
</footer>

<script>
/*
  Versi√≥n corregida de libro.html
  - Usa ISBN (si existe) para construir enlace directo a Amazon
  - Si no hay ISBN, construye b√∫squeda en Amazon con t√≠tulo+autor
  - Reemplaza scraping a Amazon (evita CORS y errores)
  - Normaliza im√°genes a https
  - Reemplaza ruta CSS por absoluta (/css/estilos.css)
  - Sustituye TU_AFFILIATE_TAG por tu tag real
*/

const AFFILIATE_TAG = "librarium01-21"; // <-- reemplaza por tu tag real si es distinto

function asegurarHttps(url) {
  if (!url) return url;
  return url.replace(/^http:\/\//i, "https://");
}

function escapeHtml(text) {
  if (text === null || text === undefined) return "";
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function generarEstrellas(rating) {
  const r = Number(rating) || 0;
  const estrellas = Math.round(r);
  return "‚≠ê".repeat(Math.max(0, Math.min(5, estrellas))) + ` (${r}/5)`;
}

function ratingAlternativo(titulo) {
  let seed = 0;
  for (let i = 0; i < titulo.length; i++) seed += titulo.charCodeAt(i);
  const random = (seed % 13) / 10;
  const rating = 3.5 + random;
  return Number(rating.toFixed(1));
}

function construirAmazonUrl(isbn13, title, author) {
  if (isbn13) {
    // Enlace directo por ISBN (funciona bien en Amazon)
    return `https://www.amazon.es/dp/${encodeURIComponent(isbn13)}?tag=${encodeURIComponent(AFFILIATE_TAG)}`;
  }
  // B√∫squeda por t√≠tulo + autor como fallback
  const q = encodeURIComponent(`${title} ${author || ""}`.trim());
  return `https://www.amazon.es/s?k=${q}&tag=${encodeURIComponent(AFFILIATE_TAG)}`;
}

async function fetchVolumeById(id) {
  const url = `https://www.googleapis.com/books/v1/volumes/${encodeURIComponent(id)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Error al obtener datos de Google Books");
  return await res.json();
}

function obtenerISBN(info) {
  if (!info || !Array.isArray(info.industryIdentifiers)) return null;
  let isbn13 = null;
  for (const id of info.industryIdentifiers) {
    if (id.type === "ISBN_13") { isbn13 = id.identifier; break; }
    if (!isbn13 && id.type === "ISBN_10") isbn13 = id.identifier; // fallback
  }
  return isbn13;
}

function renderNotFound() {
  document.getElementById("contenidoLibro").innerHTML = `
    <div style="text-align:center;padding:30px">
      <h2>No se encontr√≥ el libro</h2>
      <p>Comprueba que la URL incluye <code>?id=VOLUME_ID</code>.</p>
      <p><a href="index.html">Volver al inicio</a></p>
    </div>
  `;
}

function renderVolume(data) {
  const info = data.volumeInfo || {};
  const title = info.title || "T√≠tulo no disponible";
  const authors = info.authors ? info.authors.join(", ") : "Autor desconocido";
  const portadaRaw = info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || "img/ejemplo.jpg";
  const portada = asegurarHttps(portadaRaw);
  const description = info.description || info.subtitle || "Sin descripci√≥n disponible.";
  const rating = info.averageRating ? Number(info.averageRating) : ratingAlternativo(title);
  const isbn13 = obtenerISBN(info);
  const amazonUrl = construirAmazonUrl(isbn13, title, authors);

  // Construir HTML de forma segura: escape de texto plano
  const html = `
    <div class="grid">
      <div class="cover"><img src="${escapeHtml(portada)}" alt="Portada de ${escapeHtml(title)}"></div>
      <div class="meta">
        <h1>${escapeHtml(title)}</h1>
        <p><strong>Autor</strong>: ${escapeHtml(authors)}</p>
        <p>${generarEstrellas(rating)}</p>
        <div class="buy" style="margin-top:12px">
          <a id="buyBtn" class="btn-secondary" href="${encodeURIComponent(amazonUrl).startsWith('https%3A') ? amazonUrl : amazonUrl}" target="_blank" rel="noopener noreferrer">Comprar en Amazon</a>
          <div class="small">Si el enlace no abre el producto exacto, prueba a buscar por t√≠tulo en Amazon.</div>
        </div>
      </div>
    </div>

    <hr style="margin:18px 0">

    <section>
      <h3>Descripci√≥n</h3>
      <div id="desc">${escapeHtml(description)}</div>
    </section>
  `;

  document.getElementById("contenidoLibro").innerHTML = html;
  document.getElementById("tituloHero").textContent = title;
}

(async function init() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");
  if (!id) {
    renderNotFound();
    return;
  }

  try {
    const data = await fetchVolumeById(id);
    if (!data || data.error) {
      renderNotFound();
      return;
    }
    renderVolume(data);
  } catch (e) {
    console.error(e);
    document.getElementById("contenidoLibro").innerHTML = `
      <div style="text-align:center;padding:30px">
        <h2>Error al cargar el libro</h2>
        <p>No se pudo obtener la informaci√≥n. Int√©ntalo de nuevo m√°s tarde.</p>
        <p><a href="index.html">Volver al inicio</a></p>
      </div>
    `;
  }
})();
</script>

</body>
</html>
