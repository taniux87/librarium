<script>
  const AFFILIATE_TAG = "librarium01-21";
  let asinData = {};

  /* ‚úÖ Cargar asin.json */
  async function cargarAsinData() {
    try {
      const res = await fetch("asin.json");
      asinData = await res.json();
    } catch (e) {
      console.warn("asin.json no disponible", e);
      asinData = {};
    }
  }

  /* ‚úÖ Estrellas */
  function generarEstrellas(rating) {
    const r = Number(rating) || 0;
    return "‚≠ê".repeat(Math.round(r)) + ` (${r}/5)`;
  }

  /* ‚úÖ Rating alternativo */
  function ratingAlternativo(titulo) {
    let seed = 0;
    for (let i = 0; i < titulo.length; i++) seed += titulo.charCodeAt(i);
    return (3.5 + (seed % 13) / 10).toFixed(1);
  }

  /* ‚úÖ ISBN */
  function obtenerISBN(info) {
    if (!info.industryIdentifiers) return null;
    for (const id of info.industryIdentifiers) {
      if (id.type === "ISBN_13") return id.identifier;
      if (id.type === "ISBN_10") return id.identifier;
    }
    return null;
  }

  /* ‚úÖ Portada h√≠brida */
  function portadaLibro(info, isbnOL = null) {
    if (isbnOL) return `https://covers.openlibrary.org/b/isbn/${isbnOL}-L.jpg`;

    const isbn = obtenerISBN(info);
    if (isbn) return `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`;

    if (info.imageLinks?.thumbnail)
      return info.imageLinks.thumbnail.replace(/^http:\/\//, "https://");

    return "img/portada-default.png";
  }

  /* ‚úÖ Enlace Amazon */
  function generarEnlaceAmazon(titulo, autor, isbn) {
    const limpio = titulo.trim();
    if (asinData[limpio]) {
      return `https://www.amazon.es/dp/${asinData[limpio]}?tag=${AFFILIATE_TAG}`;
    }
    return `https://www.amazon.es/s?k=${encodeURIComponent(limpio + " " + autor)}&tag=${AFFILIATE_TAG}`;
  }

  /* ‚úÖ API 1: Google Books */
  async function buscarGoogleBooksPorID(id) {
    try {
      const url = `https://www.googleapis.com/books/v1/volumes/${encodeURIComponent(id)}`;
      const res = await fetch(url);
      if (!res.ok) return null;
      const data = await res.json();
      return {
        id,
        volumeInfo: data.volumeInfo || {},
        isbnOL: null
      };
    } catch {
      return null;
    }
  }

  /* ‚úÖ API 2: Open Library por ID */
  async function buscarOpenLibraryPorID(id) {
    try {
      const url = `https://openlibrary.org/works/${id}.json`;
      const res = await fetch(url);
      if (!res.ok) return null;
      const data = await res.json();

      return {
        id,
        volumeInfo: {
          title: data.title,
          authors: data.authors ? data.authors.map(a => a.name || "Autor desconocido") : ["Autor desconocido"],
          description: typeof data.description === "string"
            ? data.description
            : data.description?.value || "Sin descripci√≥n disponible.",
          averageRating: null,
          industryIdentifiers: data.isbn_13
            ? data.isbn_13.map(i => ({ type: "ISBN_13", identifier: i }))
            : null
        },
        isbnOL: data.isbn_13 ? data.isbn_13[0] : null
      };
    } catch {
      return null;
    }
  }

  /* ‚úÖ API 3: API Espa√±ola */
  async function buscarApiEspanolaPorID(id) {
    try {
      const url = `https://luisjdev0.github.io/libros-app-api/libro?id=${encodeURIComponent(id)}`;
      const res = await fetch(url);
      if (!res.ok) return null;
      const data = await res.json();

      if (!data || !data.titulo) return null;

      return {
        id,
        volumeInfo: {
          title: data.titulo,
          authors: data.autor ? [data.autor] : ["Autor desconocido"],
          description: data.descripcion || "Sin descripci√≥n disponible.",
          averageRating: data.rating || null,
          industryIdentifiers: data.isbn
            ? [{ type: "ISBN_13", identifier: data.isbn }]
            : null,
          imageLinks: data.portada ? { thumbnail: data.portada } : null
        },
        isbnOL: data.isbn || null
      };
    } catch {
      return null;
    }
  }

  /* ‚úÖ Fallback: buscar por t√≠tulo si el ID no sirve */
  async function buscarPorTitulo(titulo) {
    const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(titulo)}&langRestrict=es`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.items || !data.items.length) return null;

    return {
      id: data.items[0].id,
      volumeInfo: data.items[0].volumeInfo,
      isbnOL: null
    };
  }

  /* ‚úÖ Cargar libro unificado */
  async function cargarLibro() {
    await cargarAsinData();

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (!id) {
      document.getElementById("contenidoLibro").innerHTML = "<p>Error: libro no encontrado.</p>";
      return;
    }

    let libro =
      await buscarGoogleBooksPorID(id) ||
      await buscarOpenLibraryPorID(id) ||
      await buscarApiEspanolaPorID(id);

    /* ‚úÖ Si no existe por ID ‚Üí buscar por t√≠tulo */
    if (!libro) libro = await buscarPorTitulo(id);

    if (!libro) {
      document.getElementById("contenidoLibro").innerHTML = "<p>No se encontraron datos del libro.</p>";
      return;
    }

    const info = libro.volumeInfo;
    const titulo = info.title || "T√≠tulo no disponible";
    const autor = info.authors ? info.authors.join(", ") : "Autor desconocido";
    const descripcion = info.description || "Sin descripci√≥n disponible.";
    const rating = info.averageRating || ratingAlternativo(titulo);
    const isbn = obtenerISBN(info);
    const portada = portadaLibro(info, libro.isbnOL);
    const enlaceAmazon = generarEnlaceAmazon(titulo, autor, isbn);

    document.getElementById("tituloHero").textContent = titulo;

    document.getElementById("contenidoLibro").innerHTML = `
      <div class="card" style="max-width: 700px; margin: auto; display:flex; flex-wrap: wrap; gap:20px; align-items:flex-start;">
        <div style="flex:0 0 200px; width: 100%;">
          <img src="${portada}" alt="Portada libro" style="width:100%; border-radius:6px;">
        </div>
        <div style="flex:1; min-width: 300px;">
          <h3 style="margin-top:0;">${titulo}</h3>
          <p><strong>${autor}</strong></p>

          <a class="btn-secondary" href="${enlaceAmazon}" target="_blank" rel="noopener noreferrer"
             style="display:inline-block; margin:10px 0; padding:12px 20px; background:#ff9900; color:#111; border-radius:6px; text-decoration:none; font-weight:bold; border: 1px solid #e47911;">
            üõí Ver precio en Amazon
          </a>

          <p>${generarEstrellas(rating)}</p>
          <p style="margin-top:15px; line-height: 1.6;">${descripcion}</p>
        </div>
      </div>
    `;
  }

  cargarLibro();
</script>
